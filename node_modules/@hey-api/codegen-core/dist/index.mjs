import e from"ansi-colors";import t from"color-support";import n from"node:path";const r=`heyapi.node`,i=`heyapi.symbol`;e.enabled=t().hasBasic;const a={analyzer:e.greenBright,dsl:e.cyanBright,file:e.yellowBright,registry:e.blueBright,symbol:e.magentaBright};function o(t,n){let r=process.env.DEBUG;if(!r)return;let i=r.split(`,`).map(e=>e.trim().toLowerCase());if(!(i.includes(`*`)||i.includes(`heyapi:*`)||i.includes(`heyapi:${n}`)||i.includes(n)))return;let o=(a[n]??e.whiteBright)(`heyapi:${n}`);console.debug(`${o} ${t}`)}var s=class{_exports=[];_extension;_finalPath;_imports=[];_language;_logicalFilePath;_name;_nodes=[];_renderer;"~brand"=`heyapi.file`;allNames=new Map;external;id;project;topLevelNames=new Map;constructor(e,t,r){this.external=e.external??!1,this.id=t,e.language!==void 0&&(this._language=e.language),this._logicalFilePath=e.logicalFilePath.split(n.sep).join(`/`),e.name!==void 0&&(this._name=e.name),this.project=r}get exports(){return[...this._exports]}get extension(){if(this._extension)return this._extension;let e=this.language,t=e?this.project.extensions[e]:void 0;if(t&&t[0])return t[0]}get finalPath(){return this._finalPath?this._finalPath:[...this._logicalFilePath?this._logicalFilePath.split(`/`).slice(0,-1):[],`${this.name}${this.extension??``}`].join(`/`)}get imports(){return[...this._imports]}get language(){if(this._language)return this._language;if(this._nodes[0])return this._nodes[0].language}get logicalFilePath(){return this._logicalFilePath}get name(){if(this._name)return this._name;let e=this._logicalFilePath.split(`/`).pop();if(e)return e;let t=`File ${this.toString()} has no name`;throw o(t,`file`),Error(t)}get nodes(){return[...this._nodes]}get renderer(){return this._renderer}addExport(e){this._exports.push(e)}addImport(e){this._imports.push(e)}addNode(e){this._nodes.push(e),e.file=this}setExtension(e){this._extension=e}setFinalPath(e){this._finalPath=e}setLanguage(e){this._language=e}setName(e){this._name=e}setRenderer(e){this._renderer=e}toString(){return`[File ${this._logicalFilePath}#${this.id}]`}};function c(e,t){return!e||typeof e!=`object`?!1:e[`~brand`]===t}function l(e){return!e||typeof e!=`object`?!1:c(e,r)}function u(e){return c(e[`~ref`],r)}function d(e){return c(e,i)}function f(e){return c(e[`~ref`],i)}const p={c:[`.c`],"c#":[`.cs`],"c++":[`.cpp`,`.hpp`],css:[`.css`],dart:[`.dart`],go:[`.go`],haskell:[`.hs`],html:[`.html`],java:[`.java`],javascript:[`.js`,`.jsx`],json:[`.json`],kotlin:[`.kt`],lua:[`.lua`],markdown:[`.md`],matlab:[`.m`],perl:[`.pl`],php:[`.php`],python:[`.py`],r:[`.r`],ruby:[`.rb`],rust:[`.rs`],scala:[`.scala`],shell:[`.sh`],sql:[`.sql`],swift:[`.swift`],typescript:[`.ts`,`.tsx`],yaml:[`.yaml`,`.yml`]},m=({attempt:e,baseName:t})=>e===0?t:`${t}${e+1}`,h=({attempt:e,baseName:t})=>e===0?t:`${t}_${e+1}`,g={php:h,python:h,ruby:h};var _=class{_id=0;_values=new Map;project;constructor(e){this.project=e}get(e){return this._values.get(this.createFileKey(e))}isRegistered(e){return this._values.has(this.createFileKey(e))}get nextId(){return this._id++}register(e){let t=this.createFileKey(e),n=this._values.get(t);return n?e.name&&n.setName(e.name):n=new s(e,this.nextId,this.project),this._values.set(t,n),n}*registered(){for(let e of this._values.values())yield e}createFileKey(e){let t=e.logicalFilePath.split(n.sep).join(`/`);return`${e.external?`ext:`:``}${t}${e.language?`:${e.language}`:``}`}};const v=e=>({"~ref":e}),y=e=>{let t={};for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=v(e[n]));return t},b=e=>e?.[`~ref`],x=e=>{let t={};for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=b(e[n]));return t},S=e=>typeof e==`object`&&!!e&&`~ref`in e;var C=class{list=[];add(e){return this.list.push(v(e))-1}*all(){for(let e of this.list){let t=b(e);t&&(yield t)}}remove(e){this.list[e]=v(null)}update(e,t){this.list[e]=v(t)}};function w(e,t){if(e===`interface`&&t===`interface`)return!0;if(e===`interface`&&t===`type`||e===`type`&&t===`interface`||e===`type`&&t===`type`)return!1;if(e===`interface`&&t===`class`||e===`class`&&t===`interface`||e===`enum`&&t===`namespace`||e===`namespace`&&t===`enum`||e===`class`&&t===`namespace`||e===`namespace`&&t===`class`||e===`namespace`&&t===`namespace`)return!0;if(e===`enum`&&t===`enum`)return!1;if(e===`function`&&t===`namespace`||e===`namespace`&&t===`function`)return!0;let n=new Set([`class`,`enum`,`function`,`var`]),r=n.has(e),i=n.has(t);if(r&&i)return!1;let a=new Set([`interface`,`type`]);return a.has(e),a.has(t),!0}const T=e=>({children:[],localNames:new Map,parent:e,symbols:[]});var E=class{scopes=T();symbol;scope=this.scopes;constructor(e){this.symbol=e}addDependency(e){this.symbol!==b(e)&&this.scope.symbols.push(e)}analyze(e){let t=S(e)?e:v(e);f(t)?this.addDependency(t):u(t)&&b(t).analyze(this)}localNames(e){let t=new Map;for(let[n,r]of e.localNames)t.set(n,new Set(r));if(e.parent){let n=this.localNames(e.parent);for(let[e,r]of n)if(!t.has(e))t.set(e,r);else{let n=t.get(e);for(let e of r)n.add(e)}}return t}popScope(){this.scope=this.scope.parent??this.scope}pushScope(){let e=T(this.scope);this.scope.children.push(e),this.scope=e}walkScopes(e,t=this.scopes){this.scope=t;for(let n of t.symbols)e(n,t);for(let n of t.children)t=n,this.walkScopes(e,t);this.scope=this.scopes}},D=class{nodeCache=new WeakMap;analyzeNode(e){let t=this.nodeCache.get(e);if(t)return t;let n=new E(e.symbol);return e.analyze(n),this.nodeCache.set(e,n),n}analyze(e,t){for(let n of e){let e=this.analyzeNode(n);t?.(e,n)}}};const O=e=>e===`type`||e===`interface`;var k=class{analyzer=new D;cacheResolvedNames=new Set;project;constructor(e){this.project=e}plan(e){this.cacheResolvedNames.clear(),this.allocateFiles(),this.assignLocalNames(),this.resolveFilePaths(e),this.planExports(),this.planImports()}allocateFiles(){this.analyzer.analyze(this.project.nodes.all(),(e,t)=>{let n=t.symbol;if(!n)return;let r=this.project.files.register(this.symbolToFileIn(n));r.addNode(t),n.setFile(r);for(let e of n.exportFrom)this.project.files.register({external:!1,language:r.language,logicalFilePath:e});e.walkScopes(e=>{let t=b(e);if(t.external&&t.isCanonical&&!t.file){let e=this.project.files.register(this.symbolToFileIn(t));t.setFile(e)}})})}assignLocalNames(){this.analyzer.analyze(this.project.nodes.all(),(e,t)=>{let n=t.symbol;n&&this.assignTopLevelName(n,e)}),this.analyzer.analyze(this.project.nodes.all(),(e,t)=>{let n=t.file;n&&e.walkScopes(t=>{let r=b(t);r.file||this.assignLocalName(r,e,{scopesToUpdate:[n.allNames]})})})}resolveFilePaths(e){for(let t of this.project.files.registered()){if(t.external)continue;let r=this.project.fileName?.(t.name)||t.name;t.setName(r);let i=t.finalPath;i&&t.setFinalPath(n.resolve(this.project.root,i));let a={file:t,meta:e,project:this.project},o=this.project.renderers.find(e=>e.supports(a));o&&t.setRenderer(o)}}planExports(){let e=new Map,t=new Map;this.analyzer.analyze(this.project.nodes.all(),(n,r)=>{if(!r.exported)return;let i=r.symbol;if(!i)return;let a=r.file;if(a)for(let o of i.exportFrom){let s=this.project.files.register({external:!1,language:r.language,logicalFilePath:o});if(s.id===a.id)continue;let c=e.get(s);c||(c=new Map,e.set(s,c));let l=this.project.symbols.register({exported:!0,external:i.external,importKind:i.importKind,kind:i.kind,name:i.finalName});l.setFile(s),t.set(l.id,a),this.assignTopLevelName(l,n);let u=c.get(l.finalName);u||(u={kinds:new Set,symbol:l},c.set(l.finalName,u)),u.kinds.add(l.kind)}});for(let[n,r]of e){let e=new Map;for(let[,n]of r){let r=t.get(n.symbol.id),i=e.get(r);i||={canExportAll:!0,exports:[],from:r,isTypeOnly:!0};let a=[...n.kinds].every(e=>O(e)),o=n.symbol.finalName;i.exports.push({exportedName:o,isTypeOnly:a,kind:n.symbol.importKind,sourceName:n.symbol.name}),n.symbol.name!==n.symbol.finalName&&(i.canExportAll=!1),a||(i.isTypeOnly=!1),e.set(r,i)}for(let[,t]of e)n.addExport(t)}}planImports(){let e=new Map;this.analyzer.analyze(this.project.nodes.all(),t=>{let n=t.symbol;if(!n)return;let r=n.file;if(!r)return;let i=e.get(r);i||(i=new Map,e.set(r,i)),t.walkScopes(e=>{let n=b(e);if(!n.file||n.file.id===r.id)return;n.external&&this.assignTopLevelName(n,t);let a=n.file.id,o=n.finalName,s=O(n.kind),c=`${a}|${o}|${n.importKind}|${s}`,l=i.get(c);if(!l){let e=this.project.symbols.register({exported:n.exported,external:n.external,importKind:n.importKind,kind:n.kind,name:n.finalName});e.setFile(r),this.assignTopLevelName(e,t,{scope:e.file.allNames}),l={dep:n,kinds:new Set,symbol:e},i.set(c,l),l.kinds.add(e.kind)}e[`~ref`]=l.symbol})});for(let[t,n]of e){let e=new Map;for(let[,t]of n){let n=t.dep.file,r=e.get(n);r||={from:n,imports:[],isTypeOnly:!0};let i=[...t.kinds].every(e=>O(e));t.symbol.importKind===`namespace`?(r.imports=[],r.namespaceImport=t.symbol.finalName):r.imports.push({isTypeOnly:i,kind:t.symbol.importKind,localName:t.symbol.finalName,sourceName:t.dep.finalName}),i||(r.isTypeOnly=!1),e.set(n,r)}for(let[,n]of e)t.addImport(n)}}assignTopLevelName(e,t,n){e.file&&this.assignSymbolName(e,{scope:n?.scope??e.file.topLevelNames,scopesToUpdate:[e.file.allNames,t.scopes.localNames,...n?.scopesToUpdate??[]]})}assignLocalName(e,t,n){this.assignSymbolName(e,{scope:n.scope??t.localNames(t.scope),scopesToUpdate:n.scopesToUpdate})}assignSymbolName(e,t){if(this.cacheResolvedNames.has(e.id))return;let n=e.name,r=e.nameSanitizer?.(n)??n,i=1;for(;![...t.scope.get(r)??[]].every(t=>w(e.kind,t));){let t=e.node?.language||e.file?.language,a=((t?this.project.nameConflictResolvers[t]:void 0)??this.project.defaultNameConflictResolver)({attempt:i,baseName:n});if(!a)throw Error(`Unresolvable name conflict: ${e.toString()}`);r=e.nameSanitizer?.(a)??a,i+=1}e.setFinalName(r),this.cacheResolvedNames.add(e.id);let a=[t.scope,...t.scopesToUpdate];for(let t of a)this.updateScope(e,t)}updateScope(e,t){let n=e.finalName,r=t.get(n)??new Set;r.add(e.kind),t.set(n,r)}symbolToFileIn(e){return{external:!!e.external,language:e.node?.language,logicalFilePath:e.external||e.getFilePath?.(e)||this.project.defaultFileName}}},A=class{_canonical;_exported;_exportFrom;_external;_file;_finalName;_getFilePath;_importKind;_kind;_meta;_name;_nameSanitizer;_node;"~brand"=i;id;constructor(e,t){this._exported=e.exported??!1,this._exportFrom=e.exportFrom??[],this._external=e.external,this._getFilePath=e.getFilePath,this.id=t,this._importKind=e.importKind??`named`,this._kind=e.kind??`var`,this._meta=e.meta,this._name=e.name}get canonical(){return this._canonical??this}get exported(){return this.canonical._exported}get exportFrom(){return this.canonical._exportFrom}get external(){return this.canonical._external}get file(){return this.canonical._file}get finalName(){if(!this.canonical._finalName){let e=`Symbol finalName has not been resolved yet for ${this.canonical.toString()}`;throw o(e,`symbol`),Error(e)}return this.canonical._finalName}get getFilePath(){return this.canonical._getFilePath}get importKind(){return this.canonical._importKind}get isCanonical(){return!this._canonical||this._canonical===this}get kind(){return this.canonical._kind}get meta(){return this.canonical._meta}get name(){return this.canonical._name}get nameSanitizer(){return this.canonical._nameSanitizer}get node(){return this.canonical._node}setCanonical(e){this._canonical=e}setExported(e){this.assertCanonical(),this._exported=e}setExportFrom(e){this.assertCanonical(),this._exportFrom=e}setFile(e){if(this.assertCanonical(),this._file&&this._file!==e){let e=`Symbol ${this.canonical.toString()} is already assigned to a different file.`;throw o(e,`symbol`),Error(e)}this._file=e}setFinalName(e){if(this.assertCanonical(),this._finalName&&this._finalName!==e){let e=`Symbol finalName has already been resolved for ${this.canonical.toString()}.`;throw o(e,`symbol`),Error(e)}this._finalName=e}setImportKind(e){this.assertCanonical(),this._importKind=e}setKind(e){this.assertCanonical(),this._kind=e}setName(e){this.assertCanonical(),this._name=e}setNameSanitizer(e){this.assertCanonical(),this._nameSanitizer=e}setNode(e){if(this.assertCanonical(),this._node&&this._node!==e){let e=`Symbol ${this.canonical.toString()} is already bound to a different node.`;throw o(e,`symbol`),Error(e)}this._node=e,e.symbol=this}toString(){return`[Symbol ${this.name}#${this.id}]`}assertCanonical(){if(this._canonical&&this._canonical!==this){let e=`Illegal mutation of stub symbol ${this.toString()} â†’ canonical: ${this._canonical.toString()}`;throw o(e,`symbol`),Error(e)}}},j=class{_id=0;_indices=new Map;_queryCache=new Map;_queryCacheDependencies=new Map;_registered=new Set;_stubs=new Set;_stubCache=new Map;_values=new Map;get(e){return typeof e==`number`?this._values.get(e):this.query(e)[0]}isRegistered(e){let t=this.get(e);return t?this._registered.has(t.id):!1}get nextId(){return this._id++}query(e){let t=this.buildCacheKey(e),n=this._queryCache.get(t);if(n)return n.map(e=>this._values.get(e));let r=[],i=this.buildIndexKeySpace(e),a=new Set,o=!1;for(let e of i){a.add(this.serializeIndexEntry(e));let t=this._indices.get(e[0]);if(!t){o=!0;break}let n=t.get(e[1]);if(!n){o=!0;break}r.push(n)}if(o||!r.length)return this._queryCacheDependencies.set(t,a),this._queryCache.set(t,[]),[];let s=new Set(r[0]);for(let e of r.slice(1))s=new Set([...s].filter(t=>e.has(t)));let c=[...s];return this._queryCacheDependencies.set(t,a),this._queryCache.set(t,c),c.map(e=>this._values.get(e))}reference(e){let[t]=this.query(e);if(t)return t;let n=this.buildCacheKey(e),r=this._stubCache.get(n);if(r!==void 0)return this._values.get(r);let i=new A({meta:e,name:``},this.nextId);return this._values.set(i.id,i),this._stubs.add(i.id),this._stubCache.set(n,i.id),i}register(e){let t=new A(e,this.nextId);if(this._values.set(t.id,t),this._registered.add(t.id),t.meta){let e=this.buildIndexKeySpace(t.meta);this.indexSymbol(t.id,e),this.invalidateCache(e),this.replaceStubs(t,e)}return t}*registered(){for(let e of this._registered.values())yield this._values.get(e)}buildCacheKey(e){return this.buildIndexKeySpace(e).map(e=>this.serializeIndexEntry(e)).sort().join(`|`)}buildIndexKeySpace(e,t=``){let n=[];for(let[r,i]of Object.entries(e)){let e=t?`${t}.${r}`:r;i&&typeof i==`object`&&!Array.isArray(i)?n.push(...this.buildIndexKeySpace(i,e)):n.push([e,i])}return n}indexSymbol(e,t){for(let[n,r]of t){this._indices.has(n)||this._indices.set(n,new Map);let t=this._indices.get(n),i=t.get(r)??new Set;i.add(e),t.set(r,i)}}invalidateCache(e){let t=e.map(e=>this.serializeIndexEntry(e));for(let[e,n]of this._queryCacheDependencies.entries())for(let r of t)if(n.has(r)){this._queryCacheDependencies.delete(e),this._queryCache.delete(e);break}}isSubset(e,t){let n=new Map(t);for(let[t,r]of e)if(!n.has(t)||n.get(t)!==r)return!1;return!0}replaceStubs(e,t){for(let n of this._stubs.values()){let r=this._values.get(n);if(r?.meta&&this.isSubset(this.buildIndexKeySpace(r.meta),t)){let t=this.buildCacheKey(r.meta);this._stubCache.delete(t),this._stubs.delete(n),r.setCanonical(e)}}}serializeIndexEntry(e){return`${e[0]}:${JSON.stringify(e[1])}`}},M=class{files;nodes=new C;symbols=new j;defaultFileName;defaultNameConflictResolver;extensions;fileName;nameConflictResolvers;renderers;root;constructor(e){let t=e.fileName;this.defaultFileName=e.defaultFileName??`main`,this.defaultNameConflictResolver=e.defaultNameConflictResolver??m,this.extensions={...p,...e.extensions},this.fileName=typeof t==`string`?()=>t:t,this.files=new _(this),this.nameConflictResolvers={...g,...e.nameConflictResolvers},this.renderers=e.renderers??[],this.root=n.resolve(e.root).replace(/[/\\]+$/,``)}render(e){new k(this).plan(e);let t=[];for(let n of this.files.registered())if(n.finalPath&&n.renderer){let r=n.renderer.render({file:n,meta:e,project:this});t.push({content:r,path:n.finalPath})}return t}};export{s as File,M as Project,A as Symbol,o as debug,p as defaultExtensions,g as defaultNameConflictResolvers,b as fromRef,x as fromRefs,l as isNode,u as isNodeRef,S as isRef,d as isSymbol,f as isSymbolRef,r as nodeBrand,v as ref,y as refs,m as simpleNameConflictResolver,i as symbolBrand,h as underscoreNameConflictResolver};
//# sourceMappingURL=index.mjs.map